<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MMO Server From Scratch(1) - Beacon Server | Wonderland</title>
    <meta name="description" content="Personal blog home">
    <link rel="stylesheet" href="/assets/style.ec68298c.css">
    <link rel="modulepreload" href="/assets/chunks/_virtual_mermaid-config.111929ab.js">
    <link rel="modulepreload" href="/assets/chunks/Valine.min.5ef8960e.js">
    <link rel="modulepreload" href="/assets/app.7001bd85.js">
    <link rel="modulepreload" href="/assets/posts_mmo-server-from-scratch_2022_20220610-mmo-server-from-scratch(1)-beacon-server.md.fa888aca.lean.js">
    
    <meta name="author" content="dyzdyz010">
  <meta property="og:title" content="Home">
  <meta property="og:description" content="Personal blog home">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
  <meta name="twitter:title" content="MMO Server From Scratch(1) - Beacon Server | Wonderland">
  </head>
  <body>
    <div id="app"><div class="flex flex-col h-screen"><nav data-headlessui-state class="navbar border border-x-0 border-t-0 border-b-gray-200 z-[100]"><div class="mx-auto px-2 sm:px-6 lg:px-8"><div class="relative flex items-center justify-between h-16"><div class="absolute inset-y-0 right-0 flex items-center sm:hidden"><button id="headlessui-disclosure-button-53" type="button" aria-expanded="false" data-headlessui-state class="inline-flex items-center justify-center p-2 text-gray-700 hover:text-sky-700 focus:outline-none"><span class="sr-only">Open main menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" class="block h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div><div class="flex-1 flex sm:items-stretch justify-center sm:justify-start"><div class="flex-shrink-0 flex mr-10 items-center"><a href="/" class=""><img class="justify-center lg:inline h-8 w-auto" src="/blog_logo.png" alt="Logo"></a><a href="/" class="text-xl font-bold text-gray-700 hover:text-sky-700 rounded-md hidden md:inline ml-2">Wonderland</a></div><div class="hidden sm:block ml-auto"><div class="flex-1 flex space-x-1 justify-end"><!--[--><div class="px-3 py-2 inline-flex"><a href="/" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>Home</span></a></div><div class="px-3 py-2 inline-flex"><a href="/tags" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><span>Tags</span></a></div><div class="px-3 py-2 inline-flex"><div data-headlessui-state class="ml-3 relative"><div><button id="headlessui-menu-button-55" type="button" aria-haspopup="true" aria-expanded="false" data-headlessui-state class="text-gray-500 hover:text-sky-700 focus:outline-none text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path></svg> Collections <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><!----></div></div><div class="px-3 py-2 inline-flex"><a href="/about" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><span>About</span></a></div><!--]--></div></div></div></div></div><!----></nav><div class="flex flex-col lg:container lg:mx-auto mt-10 mb-20"><!--[--><div class="md:ml-[68] lg:ml-80 lg:mr-10 md:mt-20 mx-2"><div class="post-title"><h1 class="block text-4xl font-bold mb-5 text-gray-700">MMO Server From Scratch(1) - Beacon Server</h1><div class="flex flex-row flex-wrap font-medium text-gray-500"><span class="mr-4 lg:mr-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg><span>Fri, Jun 10, 2022</span></span><span class="hidden lg:inline-block md:mx-5">|</span><span class="mr-4 lg:mr-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><span>dyzdyz010</span></span><span class="hidden lg:inline-block md:mx-5">|</span><span class="break-words"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><!--[--><span class="mr-2 hover:text-sky-700 cursor-pointer">game</span><span class="mr-2 hover:text-sky-700 cursor-pointer">mmo</span><span class="mr-2 hover:text-sky-700 cursor-pointer">server</span><span class="mr-2 hover:text-sky-700 cursor-pointer">elixir</span><!--]--></span></div></div><div class="post mt-16"><div style="position:relative;"><div><p>今天来实现服务器的第一个部件 - <strong>beacon_server</strong>。</p><h2 id="功能解析" tabindex="-1">功能解析 <a class="header-anchor" href="#功能解析" aria-hidden="true">#</a></h2><p>为了建立Elixir集群，需要所有 Beam 节点在启动之时就已经知道一个固定的节点用来连接，之后 Beam 会自动完成节点之间的链接，即默认的<code>全连接</code>模式，所有节点两两之间均有连接。关于这一点我还没有深入思考过有没有必要进行调整，之后看情况再说🤪</p><p>因此，为了让服务器集群内的所有节点在启动时都能够连接一个固定节点从而组成集群，这个固定节点就是<code>beacon_server</code>。</p><p><code>beacon_server</code>需要有什么功能呢？在经过一番简单思考后，至少需要具备以下几个功能：</p><ol><li>接受其他节点的连接</li><li>接受其他节点的注册信息</li><li>相应其他节点的需求，返回需求节点的信息</li></ol><p>这里有两个重要概念：<code>资源(Resource)</code> 和 <code>需求(Requirement)</code>。<code>资源</code>指某个节点自身的内容类型，也就是在集群中所处的角色，比如网关服务器的资源就是网关(gate_server)；<code>需求</code>指某个节点需要的其他节点，比如网关节点需要**网关管理节点(gate_manager)<strong>来注册自己，数据服务节点需要</strong>数据联系节点(data_contact)**来把数据库同步到自身。</p><p>当一个节点向<code>beacon_server</code>节点注册时，我们希望它能够向<code>beacon_server</code>提供自己的节点名称、资源、需求等数据，方便<code>beacon_server</code>在收到别的节点注册时，能够把已经注册过的节点当做需求返回给别的节点。</p><h2 id="数据结构" tabindex="-1">数据结构 <a class="header-anchor" href="#数据结构" aria-hidden="true">#</a></h2><p>我用一个 <code>GenServer</code> 线程负责上面所说的所有工作，利用线程的 <code>state</code> 来保存来往节点信息。当前粗略想了想，姑且定义信息存储格式如下：</p><div class="language-elixir"><pre><code><span class="token punctuation">%</span><span class="token punctuation">{</span>
  <span class="token attr-name">nodes:</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>
    <span class="token string">&quot;node1@host&quot;</span>: <span class="token atom symbol">:online</span><span class="token punctuation">,</span>
    <span class="token string">&quot;node2@host&quot;</span>: <span class="token atom symbol">:offline</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token attr-name">requirements:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">%</span><span class="token punctuation">{</span>
      <span class="token attr-name">module:</span> <span class="token module class-name">Module</span><span class="token punctuation">.</span><span class="token module class-name">Interface</span><span class="token punctuation">,</span>
      <span class="token attr-name">name:</span> <span class="token punctuation">[</span><span class="token atom symbol">:requirement_name</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token attr-name">node:</span> :<span class="token string">&quot;node@host&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token attr-name">resources:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">%</span><span class="token punctuation">{</span>
      <span class="token attr-name">module:</span> <span class="token module class-name">Module</span><span class="token punctuation">.</span><span class="token module class-name">Interface</span><span class="token punctuation">,</span>
      <span class="token attr-name">name:</span> <span class="token atom symbol">:resoutce_name</span><span class="token punctuation">,</span>
      <span class="token attr-name">node:</span> :<span class="token string">&quot;node@host&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我用一个字典存储所有信息，分为 <code>nodes</code>、<code>requirements</code>以及<code>resources</code>三部分。</p><p><code>nodes</code>存储所有已经连接的节点和他们的状态，<code>:online</code>表示在线正常连接，<code>:offline</code>表示节点断开连接；</p><p><code>requirements</code>存储每个节点注册时提供的需求信息。使用列表存储，列表中每个项代表一个节点。项使用字典，存储模块(module)、名称(name)、节点(node)信息。其中<code>名称</code>字段，因为有些节点可能会有不只一个<code>需求</code>，因此使用列表存储。<code>模块</code>字段是为了留着以备后用，目前没什么用……<code>节点</code>字段用于获取的节点使用该字段对目标节点发送消息，必不可少。</p><p><code>resources</code>存储每个节点注册时提供的资源信息，字段与<code>requirements</code>完全相同，有一个不同的地方是<code>名称</code>字段的数据类型不再是列表，而是原子，因为每个节点只可能属于唯一的一种资源，不可能属于两种以上，因此用一个单一的原子就可以代表了。</p><h2 id="简要实现" tabindex="-1">简要实现 <a class="header-anchor" href="#简要实现" aria-hidden="true">#</a></h2><h3 id="建立项目" tabindex="-1">建立项目 <a class="header-anchor" href="#建立项目" aria-hidden="true">#</a></h3><p>这是第一个实现，在实现之前，我们先建立一个<code>umbrella</code>项目，用来存放之后的所有代码：</p><div class="language-bash"><pre><code>mix new cluster <span class="token parameter variable">--umbrella</span>
</code></pre></div><p>然后创建本节的<code>beacon_server</code>项目：</p><div class="language-bash"><pre><code><span class="token builtin class-name">cd</span> apps/
mix new beacon_server <span class="token parameter variable">--sup</span>
</code></pre></div><p><code>--sup</code>用来生成监督树。</p><p>有了项目之后，我们需要建立一个<code>GenServer</code>，用来充当其他节点用来通信的接口，我们就把他叫做<code>Beacon</code>好了。</p><h3 id="功能函数" tabindex="-1">功能函数 <a class="header-anchor" href="#功能函数" aria-hidden="true">#</a></h3><p>根据前面的设想，我们需要下面这么几个函数：</p><ul><li>register(credentials, state) - 用于把注册来的节点信息记录在 <code>state</code> 中，并将新的 <code>state</code> 返回。</li><li>get_requirements(node, requirements, resources) - 用于向已注册的节点返回其需求。</li></ul><p>下面贴上我粗略实现的代码，当然这不会是最终版本，未来还有优化的空间：</p><div class="language-elixir"><pre><code><span class="token attribute variable">@spec</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">atom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">atom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token keyword">defp</span> <span class="token function">register</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>node<span class="token punctuation">,</span> module<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> requirement<span class="token punctuation">}</span><span class="token punctuation">,</span>
        state <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">nodes:</span> connected_nodes<span class="token punctuation">,</span> <span class="token attr-name">resources:</span> resources<span class="token punctuation">,</span> <span class="token attr-name">requirements:</span> requirements<span class="token punctuation">}</span>
      <span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Register: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>node<span class="token delimiter punctuation">}</span></span> | <span class="token interpolation"><span class="token delimiter punctuation">#{</span>resource<span class="token delimiter punctuation">}</span></span> | <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span>
    <span class="token punctuation">%</span><span class="token punctuation">{</span>
      state
      <span class="token operator">|</span> <span class="token attr-name">nodes:</span> <span class="token function">add_node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> connected_nodes<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token attr-name">resources:</span> <span class="token function">add_resource</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> module<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token attr-name">requirements:</span>
          <span class="token keyword">if</span> requirement <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
            <span class="token function">add_requirement</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> module<span class="token punctuation">,</span> requirement<span class="token punctuation">,</span> requirements<span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            requirements
          <span class="token keyword">end</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token attribute variable">@spec</span> <span class="token function">get_requirements</span><span class="token punctuation">(</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">defp</span> <span class="token function">get_requirements</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> requirements<span class="token punctuation">,</span> resources<span class="token punctuation">)</span> <span class="token keyword">do</span>
  req <span class="token operator">=</span> <span class="token function">find_requirements</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> requirements<span class="token punctuation">)</span>
  offer <span class="token operator">=</span> <span class="token function">find_resources</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resources<span class="token punctuation">)</span>
  offer
<span class="token keyword">end</span>
</code></pre></div><p>上面代码中用到的其他私有函数我就不贴了，总之就是利用线程 <code>state</code> 中的数据返回新的数据。</p><p>除了这两个必要的函数，我还想添加两个能够监控节点通断的函数。这两个函数通过 <code>handle_info</code> 实现。首先需要在线程初始化的时候开启这项功能：</p><div class="language-elixir"><pre><code><span class="token atom symbol">:net_kernel</span><span class="token punctuation">.</span><span class="token function">monitor_nodes</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>之后实现两个 callback：</p><div class="language-elixir"><pre><code><span class="token comment"># ========== Node monitoring ==========</span>

<span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:nodeup</span><span class="token punctuation">,</span> node<span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Node connected: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>node<span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> state<span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:nodedown</span><span class="token punctuation">,</span> node<span class="token punctuation">}</span><span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">nodes:</span> node_list<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">critical</span><span class="token punctuation">(</span><span class="token string">&quot;Node disconnected: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>node<span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>state <span class="token operator">|</span> <span class="token attr-name">nodes:</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>node_list <span class="token operator">|</span> node <span class="token operator">=&gt;</span> <span class="token atom symbol">:offline</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p>不在 <code>:nodeup</code> 回调中将节点状态修改为 <code>:online</code> 是因为节点在注册的时候，注册函数已经将节点的状态修改为 <code>:online</code> 了。</p><h3 id="接口函数" tabindex="-1">接口函数 <a class="header-anchor" href="#接口函数" aria-hidden="true">#</a></h3><p>有了功能之后，还需要提供对外接口，<code>GenServer</code> 已经提供了相关的回调函数供我们实现，在这里我使用 <code>handle_call/3</code>，因为注册流程需要是<strong>同步</strong>的，只有注册完成之后对应节点才能开始正常运行。</p><p>同样地，对外接口也是两个，分别是 <code>:register</code> 和 <code>:get_requirements</code>：</p><div class="language-elixir"><pre><code><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token comment"># Register node with resource and requirement.</span>
<span class="token keyword">def</span> <span class="token function">handle_call</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:register</span><span class="token punctuation">,</span> credentials<span class="token punctuation">}</span><span class="token punctuation">,</span>
      _from<span class="token punctuation">,</span>
      state
    <span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;New register from <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>credentials<span class="token punctuation">,</span> <span class="token attr-name">pretty:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>.&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> new_state<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">register</span><span class="token punctuation">(</span>credentials<span class="token punctuation">,</span> state<span class="token punctuation">)</span>

  <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Register <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>credentials<span class="token punctuation">,</span> <span class="token attr-name">pretty:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span> complete.&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">ansi_color:</span> <span class="token atom symbol">:green</span><span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:reply</span><span class="token punctuation">,</span> <span class="token atom symbol">:ok</span><span class="token punctuation">,</span> new_state<span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token comment"># Reply to caller node with specified requirements</span>
<span class="token keyword">def</span> <span class="token function">handle_call</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:get_requirements</span><span class="token punctuation">,</span> node<span class="token punctuation">}</span><span class="token punctuation">,</span>
      _from<span class="token punctuation">,</span>
      state <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">nodes:</span> _<span class="token punctuation">,</span> <span class="token attr-name">resources:</span> resources<span class="token punctuation">,</span> <span class="token attr-name">requirements:</span> requirements<span class="token punctuation">}</span>
    <span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Getting requirements for <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>

  offer <span class="token operator">=</span> <span class="token function">get_requirements</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> requirements<span class="token punctuation">,</span> resources<span class="token punctuation">)</span>

  <span class="token punctuation">{</span><span class="token atom symbol">:reply</span><span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token function">length</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span> <span class="token keyword">do</span>
      <span class="token number">0</span> <span class="token operator">-&gt;</span> <span class="token boolean">nil</span>
      _ <span class="token operator">-&gt;</span> 
        <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Requirements retrieved: <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>offer<span class="token punctuation">,</span> <span class="token attr-name">pretty:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">ansi_color:</span> <span class="token atom symbol">:green</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> offer<span class="token punctuation">}</span>
    <span class="token keyword">end</span><span class="token punctuation">,</span> state<span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p>至此，<code>Beacon</code> 功能模块就基本完整了，最后我们需要把它加入到监督树里使其运行起来。在 <code>application.ex</code> 中：</p><div class="language-elixir"><pre><code><span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>_type<span class="token punctuation">,</span> _args<span class="token punctuation">)</span> <span class="token keyword">do</span>
  children <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># Starts a worker by calling: BeaconServer.Worker.start_link(arg)</span>
    <span class="token punctuation">{</span><span class="token module class-name">BeaconServer</span><span class="token punctuation">.</span><span class="token module class-name">Beacon</span><span class="token punctuation">,</span> <span class="token attr-name">name:</span> <span class="token module class-name">BeaconServer</span><span class="token punctuation">.</span><span class="token module class-name">Beacon</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>

  <span class="token comment"># See https://hexdocs.pm/elixir/Supervisor.html</span>
  <span class="token comment"># for other strategies and supported options</span>
  opts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token attr-name">strategy:</span> <span class="token atom symbol">:one_for_one</span><span class="token punctuation">,</span> <span class="token attr-name">name:</span> <span class="token module class-name">BeaconServer</span><span class="token punctuation">.</span><span class="token module class-name">Supervisor</span><span class="token punctuation">]</span>
  <span class="token module class-name">Supervisor</span><span class="token punctuation">.</span><span class="token function">start_link</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre></div><p>像这样把 <code>Beacon</code> 模块加入到监督者的子线程列表中，<code>beacon_server</code> 暂时就算完成了。</p><h2 id="效果测试" tabindex="-1">效果测试 <a class="header-anchor" href="#效果测试" aria-hidden="true">#</a></h2><p>运行一下试试：</p><div class="language-bash"><pre><code>iex <span class="token parameter variable">--name</span> beacon1@127.0.0.1 <span class="token parameter variable">--cookie</span> mmo <span class="token parameter variable">-S</span> mix
</code></pre></div><p>为了让其他节点连接，<code>name</code> 和 <code>cookie</code> 一定好设置好。</p><p>我写了点测试代码调用一下试试：</p><p><img src="/assets/20220611_beacon_server_output.79aef269.png" alt=""></p><p>最后我们看一下 <code>Beacon</code> 模块的 <code>state</code> 长什么样：</p><p><img src="/assets/20220611_beacon_state.f480e6db.png" alt=""></p><p>就先这样，后面我们会在此基础上继续实现别的服务器。</p></div></div></div><div class="comment mt-40"><div id="vcomment"></div></div></div><div class="hidden lg:block toc fixed left-8 lg:ml-12 top-40 bottom-28 overflow-auto" data-v-2d7dc61b><ul class="toc-links flex flex-col" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#功能解析" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>功能解析</a><!----></li><li class="toc-link" data-v-2d7dc61b><a href="#数据结构" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>数据结构</a><!----></li><li class="toc-link" data-v-2d7dc61b><a href="#简要实现" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>简要实现</a><ul class="toc-links flex flex-col ml-4" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#建立项目" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>建立项目</a></li><li class="toc-link" data-v-2d7dc61b><a href="#功能函数" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>功能函数</a></li><li class="toc-link" data-v-2d7dc61b><a href="#接口函数" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>接口函数</a></li><!--]--></ul></li><li class="toc-link" data-v-2d7dc61b><a href="#效果测试" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>效果测试</a><!----></li><!--]--></ul></div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="hidden sm:block fixed sm:right-8 sm:bottom-8 w-10 h-10 text-gray-600 hover:text-sky-800 cursor-pointer"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg><!--]--></div><footer class="text-center align-bottom text-gray-500 font-normal text-lg py-3 mt-auto border border-t-gray-200"><span>Powered by </span><a href="https://github.com/dyzdyz010/vitepress-theme-oblivion" target="_blank" class="text-sky-600 hover:text-sky-700"> vitepress-theme-oblivion</a><span class="mx-3">|</span><span>Copyright © </span><a href="https://github.com/dyzdyz010" target="_blank" title="作者" class="text-sky-600 hover:text-sky-700">dyzdyz010</a><span class="mx-3">|</span><span>2022 - 2022</span><span class="mx-3">|</span><span>MIT License</span></footer></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about.md\":\"acbbe5ad\",\"collections.md\":\"fd7103b4\",\"index.md\":\"c12eb994\",\"posts_blog-meta_2022_vitepress-theme-oblivion.md\":\"acbb221d\",\"posts_blog-meta_20220520-post-template.md\":\"649a867e\",\"posts_life_2017_2017-year-review.md\":\"005e606b\",\"posts_life_2017_check-in-20171027.md\":\"31f8ad45\",\"posts_life_2017_ss-module-for-surge.md\":\"6c0e1df9\",\"posts_life_2019_2019-year-review.md\":\"89e578fb\",\"posts_life_2020_new-theme-wonderland.md\":\"6ce7c0c1\",\"posts_life_2021_2021-year-review.md\":\"5b5f7a14\",\"posts_life_2021_20210507-blog-new-style.md\":\"2575f2d9\",\"posts_mmo-server-from-scratch_2022_20220608-mmo-server-from-scratch(0)-introduction.md\":\"d271ee4b\",\"posts_mmo-server-from-scratch_2022_20220610-mmo-server-from-scratch(1)-beacon-server.md\":\"fa888aca\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(2)-gate-server.md\":\"52d84268\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(3)-scene-server-aoi.md\":\"5244459f\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(4)-scene-server-aoi-data-structure.md\":\"d1a0824c\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(5)-scene-server-aoi-supervision-tree.md\":\"51641030\",\"posts_productivity_2018_enable-latex-export-logging-in-org-mode.md\":\"4cdc5f4f\",\"posts_productivity_2020_bulletproof-task-management-priority-formula.md\":\"a4b0a0ff\",\"posts_products_2017_wonderland-ghost-theme.md\":\"5e1b46f9\",\"posts_products_2018_wwdc-2018-keynot-review.md\":\"2987df03\",\"posts_recommendations_2017_acg-wallpaper-recommendation-0.md\":\"7172a448\",\"posts_recommendations_2017_europe-folk-music-playlist.md\":\"06e31597\",\"posts_study_2017_ml-bp-neural-network-review.md\":\"cb630e76\",\"posts_study_2017_ml-course-summary-review.md\":\"c30a088d\",\"posts_study_2017_ml-logistic-regression-review.md\":\"e9647cc2\",\"posts_study_2017_music-theory-pentatonic-scale.md\":\"f459c8fa\",\"posts_study_2018_quicksort-review.md\":\"d992f04a\",\"posts_thoughts_2021_20210520.md\":\"946c52de\",\"posts_thoughts_2022_20220520-thoughts-on-medical.md\":\"237e798a\",\"posts_thoughts_2022_20220902-recent-thoughts.md\":\"ba005bd2\",\"posts_tutorials_2017_logistic-regression-model-with-tensorflow-from-scratch.md\":\"8cc97dee\",\"posts_tutorials_2017_migrating-ghost-to-1-0-on-centos7.md\":\"86b97fa6\",\"posts_tutorials_2018_origin-download-speedup.md\":\"670f843c\",\"posts_tutorials_2018_set-up-flarum-from-scratch.md\":\"6675e685\",\"posts_tutorials_2018_using-virtualenv-in-jupyter-notebook.md\":\"7762e84b\",\"posts_tutorials_2019_hugo-with-github-pages.md\":\"adb061c4\",\"posts_tutorials_2019_install-kbengine-on-ubuntu-18-04-lts.md\":\"9b1b515a\",\"posts_tutorials_2020_wsl-elixir-observer.md\":\"af1dc31a\",\"posts_tutorials_2021_rhel-8-with-sas2008-raid-controllers.md\":\"5128ce1b\",\"posts_tutorials_2021_windows-git-proxy.md\":\"78a1f861\",\"posts_tutorials_2021_wsl2-firewall-fix.md\":\"176bd889\",\"posts_tutorials_2022_add-protobuf-to-ue5-project.md\":\"66319268\",\"posts_weibo_2022_20220620-about-weibo.md\":\"ab7081bd\",\"tags.md\":\"d11cd865\"}")</script>
    <script type="module" async src="/assets/app.7001bd85.js"></script>
    
  </body>
</html>