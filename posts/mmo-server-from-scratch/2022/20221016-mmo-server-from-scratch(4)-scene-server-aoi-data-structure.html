<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MMO Server From Scratch(4) - Scene Server(1) - AOI - 算法与数据结构 | Wonderland</title>
    <meta name="description" content="Personal blog home">
    <link rel="stylesheet" href="/assets/style.ec68298c.css">
    <link rel="modulepreload" href="/assets/chunks/_virtual_mermaid-config.111929ab.js">
    <link rel="modulepreload" href="/assets/chunks/Valine.min.5ef8960e.js">
    <link rel="modulepreload" href="/assets/app.7001bd85.js">
    <link rel="modulepreload" href="/assets/posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(4)-scene-server-aoi-data-structure.md.d1a0824c.lean.js">
    
    <meta name="author" content="dyzdyz010">
  <meta property="og:title" content="Home">
  <meta property="og:description" content="Personal blog home">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
  <meta name="twitter:title" content="MMO Server From Scratch(4) - Scene Server(1) - AOI - 算法与数据结构 | Wonderland">
  </head>
  <body>
    <div id="app"><div class="flex flex-col h-screen"><nav data-headlessui-state class="navbar border border-x-0 border-t-0 border-b-gray-200 z-[100]"><div class="mx-auto px-2 sm:px-6 lg:px-8"><div class="relative flex items-center justify-between h-16"><div class="absolute inset-y-0 right-0 flex items-center sm:hidden"><button id="headlessui-disclosure-button-65" type="button" aria-expanded="false" data-headlessui-state class="inline-flex items-center justify-center p-2 text-gray-700 hover:text-sky-700 focus:outline-none"><span class="sr-only">Open main menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" class="block h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div><div class="flex-1 flex sm:items-stretch justify-center sm:justify-start"><div class="flex-shrink-0 flex mr-10 items-center"><a href="/" class=""><img class="justify-center lg:inline h-8 w-auto" src="/blog_logo.png" alt="Logo"></a><a href="/" class="text-xl font-bold text-gray-700 hover:text-sky-700 rounded-md hidden md:inline ml-2">Wonderland</a></div><div class="hidden sm:block ml-auto"><div class="flex-1 flex space-x-1 justify-end"><!--[--><div class="px-3 py-2 inline-flex"><a href="/" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>Home</span></a></div><div class="px-3 py-2 inline-flex"><a href="/tags" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><span>Tags</span></a></div><div class="px-3 py-2 inline-flex"><div data-headlessui-state class="ml-3 relative"><div><button id="headlessui-menu-button-67" type="button" aria-haspopup="true" aria-expanded="false" data-headlessui-state class="text-gray-500 hover:text-sky-700 focus:outline-none text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path></svg> Collections <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><!----></div></div><div class="px-3 py-2 inline-flex"><a href="/about" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><span>About</span></a></div><!--]--></div></div></div></div></div><!----></nav><div class="flex flex-col lg:container lg:mx-auto mt-10 mb-20"><!--[--><div class="md:ml-[68] lg:ml-80 lg:mr-10 md:mt-20 mx-2"><div class="post-title"><h1 class="block text-4xl font-bold mb-5 text-gray-700">MMO Server From Scratch(4) - Scene Server(1) - AOI - 算法与数据结构</h1><div class="flex flex-row flex-wrap font-medium text-gray-500"><span class="mr-4 lg:mr-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg><span>Fri, Oct 21, 2022</span></span><span class="hidden lg:inline-block md:mx-5">|</span><span class="mr-4 lg:mr-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><span>dyzdyz010</span></span><span class="hidden lg:inline-block md:mx-5">|</span><span class="break-words"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><!--[--><span class="mr-2 hover:text-sky-700 cursor-pointer">game</span><span class="mr-2 hover:text-sky-700 cursor-pointer">mmo</span><span class="mr-2 hover:text-sky-700 cursor-pointer">server</span><span class="mr-2 hover:text-sky-700 cursor-pointer">elixir</span><!--]--></span></div></div><div class="post mt-16"><div style="position:relative;"><div><p>本节着重讨论场景服务器的 <code>AOI</code> 模块中的 <code>NIF</code> 部分，确定接口、算法和数据结构。</p><h2 id="功能解析" tabindex="-1">功能解析 <a class="header-anchor" href="#功能解析" aria-hidden="true">#</a></h2><p><code>AOI(Area Of Interest)</code> 是用来管理大世界上各种实体之间位置关系的模块，可以接受某个实体的 <strong>查询身边其他实体</strong> 的请求，同时负责维护各实体位置关系的数据结构。当实体在大世界上发生移动时，<code>AOI</code> 模块需要更新实体在数据结构中的位置，以便业务进程在请求身边实体列表时返回更新后的结果。</p><p>从描述上就可以看出，这个模块需要频繁进行列表的查询、插入、删除操作，计算量不算小，因此如果把这部分功能拿给 <code>Elixir</code> 实现的话恐怕会力不从心，运算速度不足导致客户端之间的同步操作延迟过大，影响游戏体验。因此我们选择使用更快速的办法实现这个模块——<code>NIF(Native Implemented Functions)</code>，使用执行效率更高的语言实现计算量最大的部分，同时在 <code>Elixir</code> 中提供调用接口，这样将两种语言的代码联系起来，各取所长。</p><p>经过一段时间的网上搜索，最终选定了 <a href="https://github.com/rusterlium/rustler" target="_blank" rel="noopener noreferrer">Rustler</a> 库，该库使用 <code>Rust</code> 作为 <code>NIF</code> 函数编写语言，同时提供了运行时安全保障，使得 <code>NIF</code> 函数中的错误不会Down掉整个 <code>BEAM</code> 虚拟机，而这个问题是 <code>NIF</code> 的一个重要缺陷，而 <code>Rustler</code> 解决了这个问题；同时 <code>Rust</code> 也提供了安全的内存管理特性，使得我可以不必像在 <code>C++</code> 中那样时刻关注内存分配和销毁的情况。</p><h2 id="算法和数据结构分析" tabindex="-1">算法和数据结构分析 <a class="header-anchor" href="#算法和数据结构分析" aria-hidden="true">#</a></h2><p>我们需要的操作基本分为三种：<strong>查找</strong>、<strong>插入</strong>、<strong>删除</strong>。可以选择的数据结构基本为两种：<code>数组</code> 和 <code>链表</code>。下面分别讨论两种结构的特点。</p><h3 id="数组" tabindex="-1">数组 <a class="header-anchor" href="#数组" aria-hidden="true">#</a></h3><p>数组是一块连续的内存空间，使用索引下标访问元素。</p><p>对于 <strong>查找</strong> 来说，不同情况下的时间复杂度见表：</p><table><thead><tr><th>是否拥有索引</th><th>是否有序</th><th>时间复杂度</th></tr></thead><tbody><tr><td>是</td><td>-</td><td>O(1)</td></tr><tr><td>否</td><td>否</td><td>线性查找 O(n)</td></tr><tr><td>否</td><td>是</td><td>二分查找 O(lg(n))</td></tr></tbody></table><p>对于 <code>插入</code> 和 <code>删除</code> 来说，假设已经确定元素索引，其复杂度均为 <code>O(n)</code>，因为插入和删除某个元素时，其后的元素均需要整体移动。</p><p>可以看出，<code>数组</code> 结构对于 <code>查找</code> 来说效率较高，但 <code>插入/删除</code> 元素则效率较低。</p><h3 id="链表" tabindex="-1">链表 <a class="header-anchor" href="#链表" aria-hidden="true">#</a></h3><p>链表是通过元素内指针指向其他元素形成的链式结构。</p><p>对于链表来说，由于 <code>查找</code> 只能对结构进行遍历，因此其时间复杂度为 <code>O(n)</code>。但是如果查询方持有元素且链表有序的话则可以相对降低，但在最坏情况下依然为 <code>O(n)</code>。</p><p>对于 <code>插入</code> 和 <code>删除</code> 来说，如果不考虑查找过程，链表只需要修改元素本身及前后元素的指针即可，因此其时间复杂度为 <code>O(1)</code>。</p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h3><p>对于 <code>AOI</code> 中的场景，一般是 <strong>玩家移动 -&gt; <code>AOI</code> 更新元素位置 -&gt; 玩家获取元素周围一定半径内其他元素</strong> 。当 <code>AOI</code> 更新元素位置时，意味着元素顺序会频繁变化，这样对于数组来说就失去了其最大优势—— <strong>索引</strong>。如果采用数组结构，那么对元素所作的所有操作都将有一个前置操作—— <strong>二分查找</strong>。这样的话与 <code>链表</code> 相比，效率上应该略逊一筹。</p><p><code>数组</code> 和 <code>链表</code> 都可以通过建立 <strong>层</strong> 机制进行优化，使得花费时间进一步减少。至于优化后的结构孰优孰劣，待我有时间全部实现后再做对比。</p><p>至于本系列，由于本人对链表很久不用了不甚熟悉，而且在类似问题上找到了 <a href="https://discord.com/blog/using-rust-to-scale-elixir-for-11-million-concurrent-users" target="_blank" rel="noopener noreferrer">Discord 的一篇文章</a>，该文章使用了类似 <code>跳跃表</code> 的机制，将数组变成了两层，提高了对其进行操作的速度。为了方便起见，在目前本人暂时先选择 <code>数据</code> 的形式，在 <code>Discord</code> 代码的基础上进行改造。</p><h2 id="简要实现" tabindex="-1">简要实现 <a class="header-anchor" href="#简要实现" aria-hidden="true">#</a></h2><p>首先为我们的 <code>scene_server</code> 添加依赖，将依赖项添加到 <code>mix.exx</code> 文件的 <code>deps</code> 函数中：</p><div class="language-elixir"><pre><code><span class="token punctuation">{</span><span class="token atom symbol">:rustler</span><span class="token punctuation">,</span> <span class="token string">&quot;~&gt; 0.26.0&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>然后使用命令创建 <code>NIF</code> 模块：</p><div class="language-bash"><pre><code>mix rustler.new
</code></pre></div><p>根据提示输入 <code>Elixir</code> 和 <code>Rust</code> 中的模块名称。本人使用的是 <code>SceneServer.Native.CoordinateSystem</code> 和 <code>coordinate_system</code>。</p><p>该命令会在 <code>scene_server</code> 项目文件夹下生成 <code>native</code> 文件夹，并将 <code>NIF</code> 模块文件放在其下：</p><p><img src="/assets/20221021_rustler_structure.c01b31cf.png" alt=""></p><h3 id="sortedset分析" tabindex="-1">SortedSet分析 <a class="header-anchor" href="#sortedset分析" aria-hidden="true">#</a></h3><p>上面 <code>Discord</code> 的文章中实现了一个名为 <code>SortedSet</code> 的数组结构，其包含一个元素为 <code>Bucket</code> 的数组，而 <code>Bucket</code> 则包含一个元素为 <code>Item</code> 的数组，如此将一个数组定义为两层。本节中我也将沿用这些名称，对代码进行改造。</p><h3 id="item" tabindex="-1">Item <a class="header-anchor" href="#item" aria-hidden="true">#</a></h3><p><code>Item</code> 即是最基本的元素结构体，其包含 <code>实体ID</code> 、 <code>坐标</code> 、 <code>所在轴向</code> 三个属性：</p><div class="language-rust"><pre><code><span class="token comment">// 轴向枚举类型</span>
<span class="token attribute attr-name">#[derive(NifUnitEnum, Clone, Debug, Copy)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">OrderAxis</span> <span class="token punctuation">{</span>
    <span class="token class-name">X</span><span class="token punctuation">,</span>
    <span class="token class-name">Y</span><span class="token punctuation">,</span>
    <span class="token class-name">Z</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 坐标结构体类型</span>
<span class="token attribute attr-name">#[derive(NifTuple, Clone, Debug, Copy)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CoordTuple</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> x<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> y<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> z<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Item结构体类型</span>
<span class="token attribute attr-name">#[derive(NifStruct, Clone, Debug, Copy)]</span>
<span class="token attribute attr-name">#[module = <span class="token string">&quot;Item&quot;</span>]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Item</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> cid<span class="token punctuation">:</span> <span class="token keyword">i64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> coord<span class="token punctuation">:</span> <span class="token class-name">CoordTuple</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> order_type<span class="token punctuation">:</span> <span class="token class-name">OrderAxis</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中的 <code>NifUnitEnum</code>、<code>NifTuple</code>、<code>NifStruct</code> 是为了将 <code>Rust</code> 内的类型转化为 <code>Elixir</code> 类型，从而使得其可以被传递。</p><p>为了能让 <code>Item</code> 之间能够被比较和排序，我们需要实现几个 <code>Trait</code> ：</p><ol><li>PartialEq</li><li>PartialOrd</li><li>Eq</li><li>Ord</li></ol><p>实现细节此处就不再展示了，各位看官有兴趣自行实现即可。此处之讨论一下 <code>Item</code> 之间该如何比较。</p><p>如果是 <code>排序</code> 的话，我们需要一个可以被排大小的值，在这里就是坐标值 <code>coord</code> 了，但是三个方向的顺序怎么确定呢？这是 <code>order_type</code> 就派上用场了，<code>order_type</code> 是哪个轴，那我们就把坐标里哪个轴上的数值拿来比较。</p><p>如果是 <code>查找</code> 的话，有了上面的比较大小还不够，别忘了我们的 <code>cid</code> 属性。坐标值相等并不意味着两个 <code>Item</code> 元素就是相等的。想想我们什么时候需要查找元素？只有唯一的一个场景，那就是找到对应玩家/实体的 <code>Item</code>，而实体之间的区分使用 <code>cid</code>，因此在相等条件中我们还需要加入 <code>cid</code> 相等的逻辑。</p><p>除此之外我们还需要一个 <code>distance(距离)</code> 方法，用来计算两个 <code>Item</code> 之间的距离，使用简单的勾股定理即可。</p><p>之后可以写几个单元测试用例，试一试 <code>Item</code> 的功能正不正常。</p><h3 id="bucket" tabindex="-1">Bucket <a class="header-anchor" href="#bucket" aria-hidden="true">#</a></h3><p><code>Bucket</code> 是一个包含 <code>Item</code> 数组的结构体：</p><div class="language-rust"><pre><code><span class="token attribute attr-name">#[derive(NifStruct, Clone, Debug)]</span>
<span class="token attribute attr-name">#[module = <span class="token string">&quot;Bucket&quot;</span>]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Bucket</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> data<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>作为包含元素列表的类型，<code>Bucket</code> 需要实现查找、插入、删除元素的方法。但是，贴心的 <code>Rust</code> 已经为我们实现了 <strong>二分查找</strong>；删除方法同样 <code>Rust</code> 内置类型 <code>Vec</code> 已经实现；对于插入，我们需要自行实现，对 <code>Vec</code> 的插入方法进行上层包装。这是因为我们想要让 <code>Bucket</code> 的长度固定，从 <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#guarantees" target="_blank" rel="noopener noreferrer">Rust官方文档</a>得知，<code>Vec</code> 有一个 <code>capacity(容量)</code> 属性，代表 <code>Vec</code> 预分配内存的大小，如果 <code>Vec</code> 长度超过了 <code>capacity</code>，那么 <code>Rust</code> 将需要为其额外分配内存，造成不必要的计算消耗；而且当我们需要 <code>插入/删除</code> 元素时，我们希望数组的长度越短越好。因此综合上面的因素，我们需要 <code>Bucket</code> 为固定长度。</p><p>这样一来，在插入元素的方法中，我们需要对列表长度进行判断，如果长度超过了设定的长度，则需要对列表进行 <code>分裂</code>，将一个 <code>Vec</code> 一分为二，成为两个对半分的 <code>Vec</code>。</p><p><code>Bucket</code> 作为 <code>SortedSet</code> 的元素，同样需要具备比较的能力。但是比较特殊的是，<code>Bucket</code> 的比较对象是 <code>Item</code>，这是因为我们一般查找的对象都是 <code>Item</code>，在 <code>SortedSet</code> 进行查找时，需要确定给定 <code>Item</code> 在哪个 <code>Bucket</code> 内部。</p><p>最后，<code>Bucket</code> 还需要一个功能，那就是返回给定 <code>Item</code> 一定范围内其他 <code>Item</code> 列表的方法。实现很简单，使用 <code>filter</code> 方法对列表内元素进行遍历即可，该过程可以借助 <code>Rayon</code> 库进行并行优化。</p><h3 id="sortedset" tabindex="-1">SortedSet <a class="header-anchor" href="#sortedset" aria-hidden="true">#</a></h3><p><code>SortedSet</code> 是最外层真正的元素数组。其为一个包含 <code>Bucket</code> 数组的结构体，其同时还包含容量、元素数量等属性：</p><div class="language-rust"><pre><code><span class="token attribute attr-name">#[derive(Debug, NifStruct, Clone, Copy)]</span>
<span class="token attribute attr-name">#[module = <span class="token string">&quot;Configuration&quot;</span>]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Configuration</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bucket最大容量</span>
    <span class="token keyword">pub</span> bucket_capacity<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>

    <span class="token comment">// SortedSet最大容量</span>
    <span class="token keyword">pub</span> set_capacity<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, NifStruct, Clone)]</span>
<span class="token attribute attr-name">#[module = <span class="token string">&quot;SortedSet&quot;</span>]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SortedSet</span> <span class="token punctuation">{</span>
    configuration<span class="token punctuation">:</span> <span class="token class-name">Configuration</span><span class="token punctuation">,</span>
    buckets<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Bucket</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与 <code>Bucket</code> 类似，我们也希望 <code>SortedSet</code> 有一个最大长度避免额外的内存分配开销，但是不需要分裂，只要最大容量即可。</p><p>方法实现与 <code>Bucket</code> 类似，需要 <code>新建列表</code>、<code>查找元素</code>、<code>插入元素</code>、<code>删除元素</code>、<code>查找一定范围内Item列表</code> 等方法。对于 <code>SortedSet</code> 来说，对元素的所有操作都需要先找到 <code>Bucket</code> 然后在对应 <code>Bucket</code> 中操作 <code>Item</code>。</p><h3 id="coordinatesystem" tabindex="-1">CoordinateSystem <a class="header-anchor" href="#coordinatesystem" aria-hidden="true">#</a></h3><p>最后是我们的顶层结构体 <code>CoordinateSystem</code>，包含 X、Y、Z 三个轴向的三个 <code>SortedSet</code> 成员：</p><div class="language-rust"><pre><code><span class="token attribute attr-name">#[derive(Debug, NifStruct, Clone)]</span>
<span class="token attribute attr-name">#[module = <span class="token string">&quot;CoordinateSystem&quot;</span>]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CoordinateSystem</span> <span class="token punctuation">{</span>
    configuration<span class="token punctuation">:</span> <span class="token class-name">Configuration</span><span class="token punctuation">,</span>
    axes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">SortedSet</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此处 <code>SortedSet</code> 以列表形式存储，是为了后期对其进行并行优化。例如 <code>插入元素</code> 方法：</p><div class="language-rust"><pre><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Item</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">AddResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> jobs<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">SetAddResult</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>axes
        <span class="token punctuation">.</span><span class="token function">par_iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> ss<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ss<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Item</span> <span class="token punctuation">{</span>
                cid<span class="token punctuation">:</span> item<span class="token punctuation">.</span>cid<span class="token punctuation">,</span>
                coord<span class="token punctuation">:</span> item<span class="token punctuation">.</span>coord<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                order_type<span class="token punctuation">:</span> <span class="token class-name">OrderAxis</span><span class="token punctuation">::</span><span class="token function">axis_by_index</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect_into_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> jobs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> jobs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token class-name">SetAddResult</span><span class="token punctuation">::</span><span class="token class-name">Added</span><span class="token punctuation">(</span>ix<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SetAddResult</span><span class="token punctuation">::</span><span class="token class-name">Added</span><span class="token punctuation">(</span>iy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SetAddResult</span><span class="token punctuation">::</span><span class="token class-name">Added</span><span class="token punctuation">(</span>iz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">AddResult</span><span class="token punctuation">::</span><span class="token class-name">Added</span><span class="token punctuation">(</span>ix<span class="token punctuation">,</span> iy<span class="token punctuation">,</span> iz<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">(</span>rx<span class="token punctuation">,</span> ry<span class="token punctuation">,</span> rz<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">AddResult</span><span class="token punctuation">::</span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rx<span class="token punctuation">,</span> ry<span class="token punctuation">,</span> rz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    result
<span class="token punctuation">}</span>
</code></pre></div><p>其中的 <code>par_iter_mut()</code> 方法将一个 <code>Vec</code> 中的元素转化为并行迭代器，使得 <code>map</code> 方法可以在每个元素上并行运行。</p><p><code>CoordinateSystem</code> 要实现的方法就是接口所需的所有方法，目前实现的有：</p><ol><li>建立结构</li><li>插入元素</li><li>删除元素</li><li>更新元素位置</li><li>查找一定范围内<code>Item</code>列表</li></ol><h2 id="接下来的工作" tabindex="-1">接下来的工作 <a class="header-anchor" href="#接下来的工作" aria-hidden="true">#</a></h2><p><code>Nif</code> 部分到这里基本完成，我们拥有了一个简陋但相对完整的 <code>AOI NIF</code> 库，下一步我们将继续将其接入到 <code>Elixir</code> 程序里，使其可以被玩家进程调用。</p></div></div></div><div class="comment mt-40"><div id="vcomment"></div></div></div><div class="hidden lg:block toc fixed left-8 lg:ml-12 top-40 bottom-28 overflow-auto" data-v-2d7dc61b><ul class="toc-links flex flex-col" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#功能解析" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>功能解析</a><!----></li><li class="toc-link" data-v-2d7dc61b><a href="#算法和数据结构分析" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>算法和数据结构分析</a><ul class="toc-links flex flex-col ml-4" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#数组" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>数组</a></li><li class="toc-link" data-v-2d7dc61b><a href="#链表" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>链表</a></li><li class="toc-link" data-v-2d7dc61b><a href="#总结" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>总结</a></li><!--]--></ul></li><li class="toc-link" data-v-2d7dc61b><a href="#简要实现" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>简要实现</a><ul class="toc-links flex flex-col ml-4" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#sortedset分析" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>SortedSet分析</a></li><li class="toc-link" data-v-2d7dc61b><a href="#item" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>Item</a></li><li class="toc-link" data-v-2d7dc61b><a href="#bucket" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>Bucket</a></li><li class="toc-link" data-v-2d7dc61b><a href="#sortedset" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>SortedSet</a></li><li class="toc-link" data-v-2d7dc61b><a href="#coordinatesystem" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>CoordinateSystem</a></li><!--]--></ul></li><li class="toc-link" data-v-2d7dc61b><a href="#接下来的工作" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>接下来的工作</a><!----></li><!--]--></ul></div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="hidden sm:block fixed sm:right-8 sm:bottom-8 w-10 h-10 text-gray-600 hover:text-sky-800 cursor-pointer"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg><!--]--></div><footer class="text-center align-bottom text-gray-500 font-normal text-lg py-3 mt-auto border border-t-gray-200"><span>Powered by </span><a href="https://github.com/dyzdyz010/vitepress-theme-oblivion" target="_blank" class="text-sky-600 hover:text-sky-700"> vitepress-theme-oblivion</a><span class="mx-3">|</span><span>Copyright © </span><a href="https://github.com/dyzdyz010" target="_blank" title="作者" class="text-sky-600 hover:text-sky-700">dyzdyz010</a><span class="mx-3">|</span><span>2022 - 2022</span><span class="mx-3">|</span><span>MIT License</span></footer></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about.md\":\"acbbe5ad\",\"collections.md\":\"fd7103b4\",\"index.md\":\"c12eb994\",\"posts_blog-meta_2022_vitepress-theme-oblivion.md\":\"acbb221d\",\"posts_blog-meta_20220520-post-template.md\":\"649a867e\",\"posts_life_2017_2017-year-review.md\":\"005e606b\",\"posts_life_2017_check-in-20171027.md\":\"31f8ad45\",\"posts_life_2017_ss-module-for-surge.md\":\"6c0e1df9\",\"posts_life_2019_2019-year-review.md\":\"89e578fb\",\"posts_life_2020_new-theme-wonderland.md\":\"6ce7c0c1\",\"posts_life_2021_2021-year-review.md\":\"5b5f7a14\",\"posts_life_2021_20210507-blog-new-style.md\":\"2575f2d9\",\"posts_mmo-server-from-scratch_2022_20220608-mmo-server-from-scratch(0)-introduction.md\":\"d271ee4b\",\"posts_mmo-server-from-scratch_2022_20220610-mmo-server-from-scratch(1)-beacon-server.md\":\"fa888aca\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(2)-gate-server.md\":\"52d84268\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(3)-scene-server-aoi.md\":\"5244459f\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(4)-scene-server-aoi-data-structure.md\":\"d1a0824c\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(5)-scene-server-aoi-supervision-tree.md\":\"51641030\",\"posts_productivity_2018_enable-latex-export-logging-in-org-mode.md\":\"4cdc5f4f\",\"posts_productivity_2020_bulletproof-task-management-priority-formula.md\":\"a4b0a0ff\",\"posts_products_2017_wonderland-ghost-theme.md\":\"5e1b46f9\",\"posts_products_2018_wwdc-2018-keynot-review.md\":\"2987df03\",\"posts_recommendations_2017_acg-wallpaper-recommendation-0.md\":\"7172a448\",\"posts_recommendations_2017_europe-folk-music-playlist.md\":\"06e31597\",\"posts_study_2017_ml-bp-neural-network-review.md\":\"cb630e76\",\"posts_study_2017_ml-course-summary-review.md\":\"c30a088d\",\"posts_study_2017_ml-logistic-regression-review.md\":\"e9647cc2\",\"posts_study_2017_music-theory-pentatonic-scale.md\":\"f459c8fa\",\"posts_study_2018_quicksort-review.md\":\"d992f04a\",\"posts_thoughts_2021_20210520.md\":\"946c52de\",\"posts_thoughts_2022_20220520-thoughts-on-medical.md\":\"237e798a\",\"posts_thoughts_2022_20220902-recent-thoughts.md\":\"ba005bd2\",\"posts_tutorials_2017_logistic-regression-model-with-tensorflow-from-scratch.md\":\"8cc97dee\",\"posts_tutorials_2017_migrating-ghost-to-1-0-on-centos7.md\":\"86b97fa6\",\"posts_tutorials_2018_origin-download-speedup.md\":\"670f843c\",\"posts_tutorials_2018_set-up-flarum-from-scratch.md\":\"6675e685\",\"posts_tutorials_2018_using-virtualenv-in-jupyter-notebook.md\":\"7762e84b\",\"posts_tutorials_2019_hugo-with-github-pages.md\":\"adb061c4\",\"posts_tutorials_2019_install-kbengine-on-ubuntu-18-04-lts.md\":\"9b1b515a\",\"posts_tutorials_2020_wsl-elixir-observer.md\":\"af1dc31a\",\"posts_tutorials_2021_rhel-8-with-sas2008-raid-controllers.md\":\"5128ce1b\",\"posts_tutorials_2021_windows-git-proxy.md\":\"78a1f861\",\"posts_tutorials_2021_wsl2-firewall-fix.md\":\"176bd889\",\"posts_tutorials_2022_add-protobuf-to-ue5-project.md\":\"66319268\",\"posts_weibo_2022_20220620-about-weibo.md\":\"ab7081bd\",\"tags.md\":\"d11cd865\"}")</script>
    <script type="module" async src="/assets/app.7001bd85.js"></script>
    
  </body>
</html>