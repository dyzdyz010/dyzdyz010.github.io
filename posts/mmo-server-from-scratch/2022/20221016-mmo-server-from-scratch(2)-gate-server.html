<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MMO Server From Scratch(2) - Gate Server | Wonderland</title>
    <meta name="description" content="Personal blog home">
    <link rel="stylesheet" href="/assets/style.ec68298c.css">
    <link rel="modulepreload" href="/assets/chunks/_virtual_mermaid-config.111929ab.js">
    <link rel="modulepreload" href="/assets/chunks/Valine.min.5ef8960e.js">
    <link rel="modulepreload" href="/assets/app.7001bd85.js">
    <link rel="modulepreload" href="/assets/posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(2)-gate-server.md.52d84268.lean.js">
    
    <meta name="author" content="dyzdyz010">
  <meta property="og:title" content="Home">
  <meta property="og:description" content="Personal blog home">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
  <meta name="twitter:title" content="MMO Server From Scratch(2) - Gate Server | Wonderland">
  </head>
  <body>
    <div id="app"><div class="flex flex-col h-screen"><nav data-headlessui-state class="navbar border border-x-0 border-t-0 border-b-gray-200 z-[100]"><div class="mx-auto px-2 sm:px-6 lg:px-8"><div class="relative flex items-center justify-between h-16"><div class="absolute inset-y-0 right-0 flex items-center sm:hidden"><button id="headlessui-disclosure-button-57" type="button" aria-expanded="false" data-headlessui-state class="inline-flex items-center justify-center p-2 text-gray-700 hover:text-sky-700 focus:outline-none"><span class="sr-only">Open main menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" class="block h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg></button></div><div class="flex-1 flex sm:items-stretch justify-center sm:justify-start"><div class="flex-shrink-0 flex mr-10 items-center"><a href="/" class=""><img class="justify-center lg:inline h-8 w-auto" src="/blog_logo.png" alt="Logo"></a><a href="/" class="text-xl font-bold text-gray-700 hover:text-sky-700 rounded-md hidden md:inline ml-2">Wonderland</a></div><div class="hidden sm:block ml-auto"><div class="flex-1 flex space-x-1 justify-end"><!--[--><div class="px-3 py-2 inline-flex"><a href="/" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>Home</span></a></div><div class="px-3 py-2 inline-flex"><a href="/tags" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><span>Tags</span></a></div><div class="px-3 py-2 inline-flex"><div data-headlessui-state class="ml-3 relative"><div><button id="headlessui-menu-button-59" type="button" aria-haspopup="true" aria-expanded="false" data-headlessui-state class="text-gray-500 hover:text-sky-700 focus:outline-none text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path></svg> Collections <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><!----></div></div><div class="px-3 py-2 inline-flex"><a href="/about" class="text-gray-500 hover:text-sky-700 text-base font-bold"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-5 h-5 mr-1"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><span>About</span></a></div><!--]--></div></div></div></div></div><!----></nav><div class="flex flex-col lg:container lg:mx-auto mt-10 mb-20"><!--[--><div class="md:ml-[68] lg:ml-80 lg:mr-10 md:mt-20 mx-2"><div class="post-title"><h1 class="block text-4xl font-bold mb-5 text-gray-700">MMO Server From Scratch(2) - Gate Server</h1><div class="flex flex-row flex-wrap font-medium text-gray-500"><span class="mr-4 lg:mr-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg><span>Sun, Oct 16, 2022</span></span><span class="hidden lg:inline-block md:mx-5">|</span><span class="mr-4 lg:mr-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><span>dyzdyz010</span></span><span class="hidden lg:inline-block md:mx-5">|</span><span class="break-words"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="inline-block w-4 h-4 mr-2 mb-[0.1rem]"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg><!--[--><span class="mr-2 hover:text-sky-700 cursor-pointer">game</span><span class="mr-2 hover:text-sky-700 cursor-pointer">mmo</span><span class="mr-2 hover:text-sky-700 cursor-pointer">server</span><span class="mr-2 hover:text-sky-700 cursor-pointer">elixir</span><!--]--></span></div></div><div class="post mt-16"><div style="position:relative;"><div><p>今天实现服务器的第二个部件 - <strong>gate_server</strong></p><h2 id="功能解析" tabindex="-1">功能解析 <a class="header-anchor" href="#功能解析" aria-hidden="true">#</a></h2><p>根据<a href="/posts/mmo-server-from-scratch/2022/20220608-mmo-server-from-scratch(0)-introduction.html">开篇架构设想</a>中的想法，<code>gate_server</code> 是用来接受用户连接的服务器。客户端通过 <strong>TCP Socket</strong> 的方式连接到 <code>gate_server</code> 上来， <code>gate_server</code> 负责把客户端发来的消息转发到指定的业务相关服务器上，并将服务器产生的消息发回客户端。</p><p>所以，根据上面的描述，<code>gate_server</code> 至少需要具备以下功能：</p><ol><li>连接<code>beacon_server</code>服务器，注册自身并获取自身需要的其他服务器资源</li><li>监听TCP端口并接受连接</li><li>接受客户端消息并转发至其他服务器</li><li>向客户端发送消息</li></ol><p>在 <code>Erlang/Elixir</code> 中，进程的使用是极其廉价的，这里说的进程不是系统进程，而是 <code>Beam</code> 虚拟机进程，属于用户进程。因此我打算为每个客户端传入的 <code>Socket</code> 连接分配一个 <code>GenServer</code> ，用于消息交换和状态保存。</p><p>对于消息协议，我选择了<a href="https://github.com/protocolbuffers/protobuf" target="_blank" rel="noopener noreferrer">Protobuf</a>，因此 <code>gate_server</code> 还需要具备消息的编解码能力。</p><h2 id="简要实现" tabindex="-1">简要实现 <a class="header-anchor" href="#简要实现" aria-hidden="true">#</a></h2><h3 id="建立项目" tabindex="-1">建立项目 <a class="header-anchor" href="#建立项目" aria-hidden="true">#</a></h3><p>首先建立本节的 <code>gate_server</code> 项目：</p><div class="language-bash"><pre><code><span class="token builtin class-name">cd</span> apps/
mix new gate_server <span class="token parameter variable">--sup</span>
</code></pre></div><h3 id="模块划分" tabindex="-1">模块划分 <a class="header-anchor" href="#模块划分" aria-hidden="true">#</a></h3><p>为了实现以上功能，需要划分几个模块：一个 <code>Interface</code> 模块负责集群相关操作，如注册、加入集群、获取其他服务器节点等；一个 <code>TcpAcceptor</code> 模块负责监听端口并接受TCP连接；一个 <code>TcpConnection</code> 模块负责和客户端进行通信。</p><p>按照这个设计，<code>gate_server</code>应用的监督树如下：</p><div class="language-text"><pre><code>                            application
                           /     |     \
                          /      |      \
                         /       |       \
           TcpAcceptorSup   InterfaceSup  TcpConnectionSup
                  |              |               |  
                  |              |               |  
                  |              |               |  
              Interface     TcpAcceptor   TcpConnection x N

</code></pre></div><p>其中：</p><ul><li>application - <code>gate_server</code>主程序</li><li>TcpAcceptorSup - <code>TCP</code>监听进程监督者进程</li><li>InterfaceSup - <code>Interface</code>模块监督者进程</li><li>TcpConnectionSup - <code>TcpConnection</code>模块监督者进程</li><li>Interface - 集群接口模块进程</li><li>TcpAcceptor - <code>Tcp</code>监听模块进程</li><li>TcpConnection - 用户连接进程</li></ul><h3 id="interface" tabindex="-1">Interface <a class="header-anchor" href="#interface" aria-hidden="true">#</a></h3><p>关于监督者进程的创建我就不说了，查阅各种文档都可以找到方法。首先来实现一下 <code>Interface</code> 的功能。</p><p><code>Interface</code>进程的初始化流程：</p><ol><li>建立<code>GenServer</code></li><li>连接给定的<code>beacon_server</code>节点</li><li>连接成功后调用<code>beacon_server</code>的<code>register</code>接口，注册自身</li><li>向<code>beacon_server</code>请求自身所需的其他节点</li></ol><p>受前面实现的 <code>beacon_server</code> 限制，这个流程姑且就先这样，后续再继续优化。</p><p>我不在 <code>init</code> 函数中进行以上动作，而是将逻辑放置到 <code>timeout</code> 消息处理中，使得进程尽快完成初始化开始接收消息。代码如下：</p><div class="language-elixir"><pre><code><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>_init_arg<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">auth_server:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token attr-name">server_state:</span> <span class="token atom symbol">:waiting_requirements</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token atom symbol">:timeout</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token atom symbol">:establish_links</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> state<span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token atom symbol">:establish_links</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;===Starting <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token module class-name">Application</span><span class="token punctuation">.</span><span class="token function">get_application</span><span class="token punctuation">(</span>__MODULE__<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span> node initialization===&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">ansi_color:</span> <span class="token atom symbol">:blue</span><span class="token punctuation">)</span>

    <span class="token function">join_beacon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">register_beacon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    new_state <span class="token operator">=</span> <span class="token function">get_requirements</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>

    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;===Server initialization complete, server ready===&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">ansi_color:</span> <span class="token atom symbol">:blue</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>new_state <span class="token operator">|</span> <span class="token attr-name">server_state:</span> <span class="token atom symbol">:ready</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p><code>join_beacon/0</code>、<code>register_beacon/0</code>、<code>get_requirements/1</code> 三个函数我就不放了，基本需要的东西就是 <code>Node.connect/1</code> 和 <code>GenServer.call/3</code>。</p><p>运行效果：</p><p><img src="/assets/20221016_interface.a1c50e29.png" alt=""></p><p>此时 <code>beacon_server</code> 的 <code>state</code> 数据：</p><p><img src="/assets/20221016_beacon_state.f654f164.png" alt=""></p><p>此时如果在 <code>iex</code> 中输入：</p><div class="language-elixir"><pre><code><span class="token module class-name">Node</span><span class="token punctuation">.</span>list
</code></pre></div><p>可以发现我们的 <code>gate_server</code> 已经和 <code>beacon_server</code> 建立连接了：</p><p><img src="/assets/20221016_node_list.466c03bd.png" alt=""></p><h3 id="tcpacceptor" tabindex="-1">TcpAcceptor <a class="header-anchor" href="#tcpacceptor" aria-hidden="true">#</a></h3><p><code>TcpAcceptor</code> 是用来接收 <code>TCP</code> 传入链接的进程，同样是一个 <code>GenServer</code>。这个进程的逻辑非常简单，直接看代码：</p><div class="language-elixir"><pre><code><span class="token keyword">defp</span> <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> socket<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom symbol">:gen_tcp</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:binary</span><span class="token punctuation">,</span> <span class="token attr-name">packet:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token attr-name">active:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token attr-name">reuseaddr:</span> <span class="token boolean">true</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Accepting connections on port <span class="token interpolation"><span class="token delimiter punctuation">#{</span>port<span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token function">loop_acceptor</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">defp</span> <span class="token function">loop_acceptor</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> client<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom symbol">:gen_tcp</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> pid<span class="token punctuation">}</span> <span class="token operator">=</span>
        <span class="token module class-name">DynamicSupervisor</span><span class="token punctuation">.</span><span class="token function">start_child</span><span class="token punctuation">(</span>
        <span class="token module class-name">GateServer</span><span class="token punctuation">.</span><span class="token module class-name">TcpConnectionSup</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token module class-name">GateServer</span><span class="token punctuation">.</span><span class="token module class-name">TcpConnection</span><span class="token punctuation">,</span> client<span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

    <span class="token atom symbol">:ok</span> <span class="token operator">=</span> <span class="token atom symbol">:gen_tcp</span><span class="token punctuation">.</span><span class="token function">controlling_process</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> pid<span class="token punctuation">)</span>

    <span class="token function">loop_acceptor</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre></div><p><code>listen/1</code> 函数用来监听指定的端口，在成功之后开始接受传入 <code>TCP</code> 连接；<code>loop_acceptor/1</code> 函数用来循环接受 <code>TCP</code> 连接，一旦接受一个连接，则为其创建一个 <code>TcpConnection</code> 进程，并将该链接的 <code>socket</code> 控制权转交给新生成的 <code>TcpConnection</code> 进程。在 <code>Elixir</code> 中，尾递归可以被优化，不会无限制占用栈空间，因此在函数的最末尾进行递归调用实现循环接受 <code>TCP</code> 连接。</p><h3 id="tcpconnection" tabindex="-1">TcpConnection <a class="header-anchor" href="#tcpconnection" aria-hidden="true">#</a></h3><p>这是本节最核心的功能模块，负责与客户端的一切通信。</p><p><code>TcpConnection</code> 同样是一个 <code>GenServer</code>，用于保存一些状态和传输 <code>TCP</code> 数据。其初始化函数如下：</p><div class="language-elixir"><pre><code><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;New client connected.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:ok</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">socket:</span> socket<span class="token punctuation">,</span> <span class="token attr-name">status:</span> <span class="token atom symbol">:waiting_auth</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p>可以看到，我们把 <code>socket</code> 信息存入了进程的 <code>state</code> 中，方便后续调取。此处的 <code>status</code> 属性暂且抛开不管，用于后续用户的鉴权，本节不作讨论。</p><p>接下来是本进程的核心函数 - <code>TCP</code> 消息接收函数：</p><div class="language-elixir"><pre><code><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:tcp</span><span class="token punctuation">,</span> _socket<span class="token punctuation">,</span> data<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">socket:</span> socket<span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
    result <span class="token operator">=</span> <span class="token string">&quot;You&#39;ve typed: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>data<span class="token delimiter punctuation">}</span></span>&quot;</span>
    <span class="token function">send_data</span><span class="token punctuation">(</span>senddata<span class="token punctuation">,</span> socket<span class="token punctuation">)</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:noreply</span><span class="token punctuation">,</span> state<span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p>此处为了方便测试，先写一个简单的 <strong>echo</strong> 功能。<code>GenServer</code> 还贴心地提供了对 <code>TCP</code> 连接状态变化的处理，只需实现以下两个函数：</p><div class="language-elixir"><pre><code><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:tcp_closed</span><span class="token punctuation">,</span> _conn<span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Socket <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>socket<span class="token punctuation">,</span> <span class="token attr-name">pretty:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span> closed unexpectly.&quot;</span><span class="token punctuation">)</span>
    <span class="token module class-name">DynamicSupervisor</span><span class="token punctuation">.</span><span class="token function">terminate_child</span><span class="token punctuation">(</span><span class="token module class-name">GateServer</span><span class="token punctuation">.</span><span class="token module class-name">TcpConnectionSup</span><span class="token punctuation">,</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:stop</span><span class="token punctuation">,</span> <span class="token atom symbol">:normal</span><span class="token punctuation">,</span> state<span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> <span class="token function">handle_info</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:tcp_error</span><span class="token punctuation">,</span> _conn<span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Socket <span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token function">inspect</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>socket<span class="token punctuation">,</span> <span class="token attr-name">pretty:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span> error: <span class="token interpolation"><span class="token delimiter punctuation">#{</span>err<span class="token delimiter punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
    <span class="token module class-name">DynamicSupervisor</span><span class="token punctuation">.</span><span class="token function">terminate_child</span><span class="token punctuation">(</span><span class="token module class-name">GateServer</span><span class="token punctuation">.</span><span class="token module class-name">TcpConnectionSup</span><span class="token punctuation">,</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">{</span><span class="token atom symbol">:stop</span><span class="token punctuation">,</span> <span class="token atom symbol">:normal</span><span class="token punctuation">,</span> state<span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre></div><p>这里我们就可以对 <code>TCP</code> 的连接建立以及信息收发功能进行测试了。假设我的 <code>gate_server</code> 运行在本机 <code>29000</code> 端口上，我们运行 <code>Telnet</code>：</p><div class="language-powershell"><pre><code>telnet 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 29000
</code></pre></div><p>即可开始与服务器进行通信。测试结果：</p><p><img src="/assets/20221016_echo_test.74cf7a2b.png" alt=""></p><h2 id="接下来的工作" tabindex="-1">接下来的工作 <a class="header-anchor" href="#接下来的工作" aria-hidden="true">#</a></h2><p><code>gate_server</code> 到这里暂告一段落，一个能够接受 <code>TCP</code> 客户端连接并且进行高并发通信的服务器就基本完成了。下一步我们将继续实现消息协议相关内容，引入 <code>Protobuf</code> 消息库并进行消息分发，进一步完善网关服务器功能。此部分功能等到下一步实现场景服务器 <code>scene_server</code> 后再回来继续，敬请期待！</p></div></div></div><div class="comment mt-40"><div id="vcomment"></div></div></div><div class="hidden lg:block toc fixed left-8 lg:ml-12 top-40 bottom-28 overflow-auto" data-v-2d7dc61b><ul class="toc-links flex flex-col" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#功能解析" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>功能解析</a><!----></li><li class="toc-link" data-v-2d7dc61b><a href="#简要实现" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>简要实现</a><ul class="toc-links flex flex-col ml-4" data-v-2d7dc61b><!--[--><li class="toc-link" data-v-2d7dc61b><a href="#建立项目" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>建立项目</a></li><li class="toc-link" data-v-2d7dc61b><a href="#模块划分" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>模块划分</a></li><li class="toc-link" data-v-2d7dc61b><a href="#interface" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>Interface</a></li><li class="toc-link" data-v-2d7dc61b><a href="#tcpacceptor" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>TcpAcceptor</a></li><li class="toc-link" data-v-2d7dc61b><a href="#tcpconnection" class="l2 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-light text-sm hover:text-sky-800" data-v-2d7dc61b>TcpConnection</a></li><!--]--></ul></li><li class="toc-link" data-v-2d7dc61b><a href="#接下来的工作" class="l1 toc-link-item block pr-4 py-1 border-r-2 border-r-gray-300 text-gray-500 font-normal text-sm hover:text-sky-800" data-v-2d7dc61b>接下来的工作</a><!----></li><!--]--></ul></div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="hidden sm:block fixed sm:right-8 sm:bottom-8 w-10 h-10 text-gray-600 hover:text-sky-800 cursor-pointer"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg><!--]--></div><footer class="text-center align-bottom text-gray-500 font-normal text-lg py-3 mt-auto border border-t-gray-200"><span>Powered by </span><a href="https://github.com/dyzdyz010/vitepress-theme-oblivion" target="_blank" class="text-sky-600 hover:text-sky-700"> vitepress-theme-oblivion</a><span class="mx-3">|</span><span>Copyright © </span><a href="https://github.com/dyzdyz010" target="_blank" title="作者" class="text-sky-600 hover:text-sky-700">dyzdyz010</a><span class="mx-3">|</span><span>2022 - 2022</span><span class="mx-3">|</span><span>MIT License</span></footer></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about.md\":\"acbbe5ad\",\"collections.md\":\"fd7103b4\",\"index.md\":\"c12eb994\",\"posts_blog-meta_2022_vitepress-theme-oblivion.md\":\"acbb221d\",\"posts_blog-meta_20220520-post-template.md\":\"649a867e\",\"posts_life_2017_2017-year-review.md\":\"005e606b\",\"posts_life_2017_check-in-20171027.md\":\"31f8ad45\",\"posts_life_2017_ss-module-for-surge.md\":\"6c0e1df9\",\"posts_life_2019_2019-year-review.md\":\"89e578fb\",\"posts_life_2020_new-theme-wonderland.md\":\"6ce7c0c1\",\"posts_life_2021_2021-year-review.md\":\"5b5f7a14\",\"posts_life_2021_20210507-blog-new-style.md\":\"2575f2d9\",\"posts_mmo-server-from-scratch_2022_20220608-mmo-server-from-scratch(0)-introduction.md\":\"d271ee4b\",\"posts_mmo-server-from-scratch_2022_20220610-mmo-server-from-scratch(1)-beacon-server.md\":\"fa888aca\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(2)-gate-server.md\":\"52d84268\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(3)-scene-server-aoi.md\":\"5244459f\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(4)-scene-server-aoi-data-structure.md\":\"d1a0824c\",\"posts_mmo-server-from-scratch_2022_20221016-mmo-server-from-scratch(5)-scene-server-aoi-supervision-tree.md\":\"51641030\",\"posts_productivity_2018_enable-latex-export-logging-in-org-mode.md\":\"4cdc5f4f\",\"posts_productivity_2020_bulletproof-task-management-priority-formula.md\":\"a4b0a0ff\",\"posts_products_2017_wonderland-ghost-theme.md\":\"5e1b46f9\",\"posts_products_2018_wwdc-2018-keynot-review.md\":\"2987df03\",\"posts_recommendations_2017_acg-wallpaper-recommendation-0.md\":\"7172a448\",\"posts_recommendations_2017_europe-folk-music-playlist.md\":\"06e31597\",\"posts_study_2017_ml-bp-neural-network-review.md\":\"cb630e76\",\"posts_study_2017_ml-course-summary-review.md\":\"c30a088d\",\"posts_study_2017_ml-logistic-regression-review.md\":\"e9647cc2\",\"posts_study_2017_music-theory-pentatonic-scale.md\":\"f459c8fa\",\"posts_study_2018_quicksort-review.md\":\"d992f04a\",\"posts_thoughts_2021_20210520.md\":\"946c52de\",\"posts_thoughts_2022_20220520-thoughts-on-medical.md\":\"237e798a\",\"posts_thoughts_2022_20220902-recent-thoughts.md\":\"ba005bd2\",\"posts_tutorials_2017_logistic-regression-model-with-tensorflow-from-scratch.md\":\"8cc97dee\",\"posts_tutorials_2017_migrating-ghost-to-1-0-on-centos7.md\":\"86b97fa6\",\"posts_tutorials_2018_origin-download-speedup.md\":\"670f843c\",\"posts_tutorials_2018_set-up-flarum-from-scratch.md\":\"6675e685\",\"posts_tutorials_2018_using-virtualenv-in-jupyter-notebook.md\":\"7762e84b\",\"posts_tutorials_2019_hugo-with-github-pages.md\":\"adb061c4\",\"posts_tutorials_2019_install-kbengine-on-ubuntu-18-04-lts.md\":\"9b1b515a\",\"posts_tutorials_2020_wsl-elixir-observer.md\":\"af1dc31a\",\"posts_tutorials_2021_rhel-8-with-sas2008-raid-controllers.md\":\"5128ce1b\",\"posts_tutorials_2021_windows-git-proxy.md\":\"78a1f861\",\"posts_tutorials_2021_wsl2-firewall-fix.md\":\"176bd889\",\"posts_tutorials_2022_add-protobuf-to-ue5-project.md\":\"66319268\",\"posts_weibo_2022_20220620-about-weibo.md\":\"ab7081bd\",\"tags.md\":\"d11cd865\"}")</script>
    <script type="module" async src="/assets/app.7001bd85.js"></script>
    
  </body>
</html>